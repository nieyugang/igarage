<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="robots" content="all,follow">
    <link rel="stylesheet" href="../../vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../vendor/layui/css/layui.css">
    <link rel="stylesheet" href="" id="layui-theme-stylesheet">
    <style>
        #hikGetHelp:hover{
            cursor: pointer;
        }

    </style>
</head>

<body>
<div class="layui-form layui-row"
     style="height: 56px;box-shadow: 5px 10px 15px 2px rgba(0,0,0,0.1);">
    <div class="layui-col-md2" style="height: 100%;font-size:24px;display: flex;justify-content: left;  align-items: center;">
        <i class="fa fa-bars" ></i>&nbsp;&nbsp;监控维护
    </div>
    <div class="layui-col-md2" style="height: 100%;display: flex;   justify-content: center;  align-items: center;">
        <div class="layui-col-md4">选择一级代理</div>
        <div class="layui-col-md7">
            <select name="firstTierAgent" id="firstTierAgent" lay-filter="firstTierAgent">
                <option>请选择</option>
            </select>
        </div>
    </div>
    <div class="layui-col-md2" style="height: 100%;display: flex;   justify-content: center;  align-items: center;">
        <div class="layui-col-md4">选择二级代理</div>
        <div class="layui-col-md7">
            <select name="twoTierAgent" id="twoTierAgent" lay-filter="twoTierAgent">
                <option>请选择</option>
            </select>
        </div>
    </div>
    <div class="layui-col-md2"  style="height: 100%;display: flex;   justify-content: center;  align-items: center;">
        <div class="layui-col-md4">选择三级代理</div>
        <div class="layui-col-md7">
            <select name="threeTierAgent" id="threeTierAgent" lay-filter="threeTierAgent">
                <option>请选择</option>
            </select>
        </div>
    </div>
    <div class="layui-col-md4"  style="height: 100%;display: flex; justify-content: center;  align-items: center;">
        <div class="layui-col-md5">
            <select name="garageList" id="garageList" lay-filter="garageList">
                <option>请选择</option>
            </select>
        </div>
        <div class="layui-col-md7">
            <button type="button" class="layui-btn layui-btn-radius" id="cameraAddPageBtn">增加监控</button>
            <button type="button" class="layui-btn layui-btn-radius" id="hikWebCamBtn">更新萤石云监控</button>
        </div>
    </div>
</div>
<div class="work-area" style="margin-top: 10px;margin-left: 10px;height: 100%">
    <!-- ===================================================== -->
    <!-- 请在此处编写你的业务代码 -->
    <!-- ===================================================== -->
    <div class="row" style="background-color: white;">
        <div class="layui-col-md12">

            <div class="layui-col-md12">
                <table class="layui-hide" id="cameraTable" lay-filter="cameraTable"></table>
            </div>
        </div>
    </div>
</div>

<script type="text/html" id="editBar">
    <button type="button" class="layui-btn layui-btn layui-btn-warm layui-btn-xs" style="background-color: #c69500" lay-event="edit">编辑</button>
    <button type="button" class="layui-btn layui-btn-danger layui-btn-xs" style="background-color: red" lay-event="delete">删除</button>
</script>

<script type="text/html" id="cameraEditPage">
    <div class="container" style="width: 98%">
        <div class="layui-form">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>编辑监控</legend>
            </fieldset>
            <form class="layui-form layui-form-pane" id="cameraEditPageFrom" action="" lay-filter="camera-edit">
                <input type="hidden" id="cameraId" name="cameraId">
                <div class="layui-form-item">
                    <label class="layui-form-label">监控名称</label>
                    <div class="layui-input-block">
                        <input type="text" name="cameraName" autocomplete="off" id="cameraName"
                               placeholder="监控名称"
                               lay-reqtext="监控名称不能为空" lay-verify="required" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">监控类型</label>
                    <div class="layui-input-block">
                        <select name="cameraType" id="cameraType" lay-filter="cameraType" lay-reqtext="监控类型不能为空" lay-verify="required">
                        </select>
                    </div>
                </div>

                <div class="Intranet">
                    <div class="layui-form-item">
                        <label class="layui-form-label">监控ip</label>
                        <div class="layui-input-block">
                            <input type="text" name="ip" autocomplete="off" id="ip" placeholder="监控ip"
                                lay-reqtext="监控ip不能为空" lay-verify="required" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">监控端口</label>
                        <div class="layui-input-block">
                            <input type="text" name="port" autocomplete="off" id="port"
                                placeholder="监控端口"
                                lay-reqtext="监控端口不能为空" lay-verify="required" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">登录账号</label>
                        <div class="layui-input-block">
                            <input type="text" name="loginAccount" autocomplete="off" id="loginAccount"
                                placeholder="登录账号"
                                lay-reqtext="登录账号不能为空" lay-verify="required" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">登录密码</label>
                        <div class="layui-input-block">
                            <input type="text" name="password" autocomplete="off" id="password"
                                placeholder="登录密码"
                                lay-reqtext="登录密码不能为空" lay-verify="required" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">安装地址</label>
                        <div class="layui-input-block">
                            <input type="text" name="installAddress" autocomplete="off" id="installAddress"
                                placeholder="安装地址"
                                lay-reqtext="安装地址不能为空" lay-verify="required" class="layui-input">
                        </div>
                    </div>
                </div>

                <div class = "hikExtranet">
                    <div class="layui-form-item">
                            <label class="layui-form-label">AppKey</label>
                            <div class="layui-input-block">
                                <input type="text" name="AppKey" autocomplete="off" id="AppKey" placeholder="AppKey"
                                lay-reqtext="Appkey不能为空" lay-verify="required" class="layui-input">
                            </div>
                    </div>
                    <div class="layui-form-item">
                            <label class="layui-form-label">AppSecret</label>
                            <div class="layui-input-inline">
                                <input type="text" name="AppSecret" autocomplete="off" id="AppSecret" placeholder="AppSecret"
                                    lay-reqtext="AppSecret不能为空" lay-verify="required" class="layui-input">
                            </div>
                            <div class="layui-form-mid layui-word-aux" id="hikGetHelp"><em  style="color:red">不知如何获取AppKey和AppSecret?</em></div>
                     </div>
                    <div class="layui-form-item">
                            <label class="layui-form-label">设备编号</label>
                            <div class="layui-input-block">
                                <input type="text" name="device" autocomplete="off" id="device" placeholder="设备编号"
                                    lay-reqtext="设备编号不能为空" lay-verify="required" class="layui-input">
                            </div>
                    </div>

                </div>

                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button class="layui-btn" lay-submit="" type="button" lay-filter="cameraFormSubmit">立即提交
                        </button>
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</script>

<!-- js插件 -->
<script src="../../vendor/jquery/jquery.min.js"></script>
<script src="../../vendor/layui/layui.js" charset="utf-8"></script>
<!-- js公共代码 -->
<script src="../../js/common.js"></script>
<script src="../../js/front.js"></script>
<script>
    var maintainInfo;//车库

    layui.use(['tree', 'util', 'table', 'element', 'upload', 'form', 'layedit', 'laydate', 'tableSelect'], function () {
        var tree = layui.tree
            , layer = layui.layer
            , table = layui.table
            , element = layui.element
            , $ = layui.jquery
            , form = layui.form
            , tableSelect = layui.tableSelect
            , laydate = layui.laydate;
        // -----------------------------------页面初始化做的操作----------------------------------
        var cameraTypeList;//监控类型

        //查询监控类型
        sendAjaxRequest("POST", "/getSysCodesAndName.json", "json", JSON.stringify({"typeList": [{"type": "cameraType"}]}), function (res) {
            if (res.resFlag === 'N') {
                if (res.cameraTypeList) {
                    cameraTypeList = res.cameraTypeList;
                }
            } else {
                layer.msg("查询失败");
            }
        }, function () {
            layer.msg("查询失败");
        });

        var cameraCols = [[
            {type: 'numbers', title: '序号', width: 80, fixed: 'center'},

            {
                field: 'cameraName', title: '监控名称', sort: false, fixed: 'center'
            },
            {
                field: 'cameraTypeName', title: '监控类型', sort: false, fixed: 'center'
            },
            {
                field: 'ip', title: '监控ip', sort: false, fixed: 'center'
            },
            {
                field: 'loginAccount', title: '登录账号', sort: false, fixed: 'center'
            },
            {
                field: 'installAddress', title: '安装地址描述', sort: false, fixed: 'center'
            },
            {
                field: 'status', title: '状态', sort: false, fixed: 'center'
            },
            {
                field: 'memoId', title: '操作', toolbar: "#editBar", sort: false, fixed: 'center'
            }
        ]];

        function cameraRes(res) {
            return {
                code: 0,
                msg: "",
                data: res.cameraInfoList
            };
        }

        var cameraTableIns = initNotPageTable(table, "cameraTable", "/getCameraList.json", {garageId: -1}, cameraRes, cameraCols, null);

        //监听监控行工具事件
        table.on('tool(cameraTable)', function (obj) {
            var data = obj.data;
            if (obj.event === 'edit') {
                openCameraEditPage();
                if("2"==data.cameraType){
                    $(".Intranet").hide();
                    $(".hikExtranet").show();
                }else{
                    $(".Intranet").show();
                    $(".hikExtranet").hide();
                }
                setCamera(data);
                form.render();
            } else if (obj.event === 'delete') {
                sendDelRequest("cameraDelete.json", JSON.stringify({cameraId: data.cameraId}), cameraTableIns);
            }
        });

        function setCamera(data) {
            $("#cameraId").val(data.cameraId)
            $("#cameraName").val(data.cameraName);
            $("#cameraType").val(data.cameraType);
            $("#ip").val(data.ip);
            $("#port").val(data.port);
            $("#loginAccount").val(data.loginAccount);
            $("#password").val(data.password);
            $("#installAddress").val(data.installAddress);
        }

        function clearCamera() {
            $("#cameraId").val("")
            $("#cameraName").val("");
            $("#cameraType").val("");
            $("#ip").val("");
            $("#port").val("");
            $("#loginAccount").val("");
            $("#password").val("");
            $("#installAddress").val("");
        }

        //打开增加修改监控页面
        $("#cameraAddPageBtn").click(function (event) {
            openCameraEditPage();
        });

        function openCameraEditPage() {
            layer.open({
                type: 1
                , title: false //不显示标题栏
                , area: ['600px', '600px']
                , id: 'lay-cameraAddPageBtn' //设定一个id，防止重复弹出
                , content: $("#cameraEditPage").html()
            });
            clearCamera();
            $("#cameraType").html("");
            $("#cameraType").append("<option value=''>---请选择---</option>");
            for (var i = 0; i < cameraTypeList.length; i++) {
                var cameraType = cameraTypeList[i];
                $("#cameraType").append("<option value=" + cameraType.code + ">" + cameraType.name + "</option>")
            }
            form.render();
        }

        //打开增加修改监控页面
        $("#cameraAddPageBtn").click(function (event) {
            openCameraEditPage();
            $(".Intranet").hide();
            $(".hikExtranet").hide();
            //获取帮助
            $("#hikGetHelp").click(function(){
                var index =  layer.open({
                    type: 1, //Page层类型
                    maxmin : true,
                    shade: 0.6, //遮罩透明度
                    anim: 1, //0-6的动画形式，-1不开启
                    content: '<div style="padding:50px;">'
                        +'<p>登陆萤石云平台：https://open.ys7.com/console/application.html；点击我的应用</p></br>'
                        +'<img src="../../img/hikvision-help/hik-help.png"></img></div>'
                });
                layer.full(index);
            });
        });

        $("#hikWebCamBtn").click(function(){
            //执行批量更新操作
            sendAjaxRequest("POST", "/hikUpdateWebDevice.json", "json",  JSON.stringify({ "userInfo": userInfo}), updateSuccess);
            function updateSuccess(res){
                if("N"== res.resFlag){
                    layer.msg("操作成功",{icon:1});
                }
            }
        });

        //监听摄像头类型下拉选择事件
        form.on('select(cameraType)', function(data){
            if("2"==data.value){//海康外网
                $(".Intranet").hide();
                $(".hikExtranet").show();
            }else{
                $(".Intranet").show();
                $(".hikExtranet").hide();
            }


        });

        //监控新增监听提交
        form.on('submit(cameraFormSubmit)', function () {
            var data = $("#cameraEditPageFrom").serializeObject();
            var url = "/cameraAdd.json";
            if (data.cameraId) {
                data.cameraId = parseInt(data.cameraId)
                url = "/cameraUpdate.json";
            }
            data.port = parseInt(data.port);
            data.cameraType = parseInt(data.cameraType);
            data.garageId = parseInt(maintainInfo.garageId);
            sendAjaxRequest("POST", url, "json", JSON.stringify(data), function (res) {
                if (res.resFlag === 'N') {
                    layer.msg("保存成功");
                    noPageTableReload(cameraTableIns, {garageId: maintainInfo.garageId});
                    layer.closeAll();
                } else {
                    layer.msg("保存失败");
                }
            }, function () {
                layer.msg("操作失败");
            });
            return false;
        });

// ----------------------------机构数-----------------------------
        selectOrg(null, 1);

        function selectOrg(level, orgId) {
            var data;
            if (level) {
                data = JSON.stringify({"queryOrgLevel": level, "orgId": orgId})
            } else {
                data = JSON.stringify({"orgId": orgId})
            }
            sendAjaxRequest("POST", "/getOrgTree.json", "json", data, function (res) {
                if (res.resFlag === 'N') {
                    if (!level) {
                        setOrgSelect(res.orgTreeInfo.childOrgList, "#firstTierAgent", 1);
                    } else if (level === 2) {
                        setOrgSelect(res.orgTreeInfo.childOrgList, "#twoTierAgent", 2);
                    } else if (level === 3) {
                        setOrgSelect(res.orgTreeInfo.childOrgList, "#threeTierAgent", 3);
                    }
                } else {
                    layer.msg("查询失败");
                }
            }, function () {
                layer.msg("查询失败");
            });
        }

        function setOrgSelect(childOrgList, id, level) {
            $(id).html("");
            if (childOrgList) {
                for (var i = 0; i < childOrgList.length; i++) {
                    var childOrg = childOrgList[i];
                    $(id).append("<option value=" + childOrg.orgId + ">" + childOrg.orgName + "</option>")
                }
                $(id).attr("disabled", false);
                if (childOrgList.length > 0) {
                    var childOrg = childOrgList[0]
                    if (childOrgList.length === 1) {
                        $(id).attr("disabled", true);
                    }
                    if (level === 1 || level === 2) {
                        selectOrg(level + 1, childOrg.orgId)
                    } else {
                        initCharge(parseInt(childOrg.orgId));
                    }
                }
            }
            form.render();
        }

        function initCharge(orgId) {
            sendAjaxRequest("POST", "/getGarageList.json", "json", JSON.stringify({
                "orgId": orgId,
                "pageNo": 1,
                "pageSize": 20
            }), function (res) {
                if (res.resFlag === 'N') {
                    if (res.rows && res.rows.length > 0) {
                        $("#garageList").html("");
                        maintainInfo = res.rows[0];
                        noPageTableReload(cameraTableIns, {garageId: maintainInfo.garageId});
                        for (var i = 0; i < res.rows.length; i++) {
                            var garage = res.rows[i];
                            $("#garageList").append("<option value=" + garage.garageId + ">" + garage.garageName + "</option>")
                        }
                        form.render();
                        if(res.totalPages > 1){
                            for(var i = 2; i <= res.totalPages; i++){
                                getGarageList(orgId, i);
                            }
                        }
                    } else {
                        maintainInfo = null;
                        noPageTableReload(cameraTableIns, {garageId: 0});
                        $("#garageList").val("");
                    }
                } else {
                    layer.msg("查询失败");
                }
            }, function () {
                layer.msg("查询失败");
            });
        }

        function getGarageList(orgId, pageNo){
            sendAjaxRequest("POST", "/getGarageList.json", "json", JSON.stringify({"orgId": orgId, "pageNo": pageNo, "pageSize": 20}), function (res) {
                if (res.resFlag === 'N') {
                    if(res.rows && res.rows.length > 0){
                        for (var i = 0; i < res.rows.length; i++) {
                            var garage = res.rows[i];
                            $("#garageList").append("<option value=" + garage.garageId + ">" + garage.garageName + "</option>")
                        }
                        form.render();
                    }
                } else {
                    layer.msg("查询失败");
                }
            }, function () {
                layer.msg("查询失败");
            });
        }

        form.on('select(firstTierAgent)', function (data) {
            selectOrg(2, parseInt(data.value));
        });

        form.on('select(twoTierAgent)', function (data) {
            selectOrg(3, parseInt(data.value));
        });

        form.on('select(threeTierAgent)', function (data) {
            initCharge(parseInt(data.value));
        });

        form.on('select(garageList)', function (data) {
            maintainInfo.garageId = parseInt(data.value);
            noPageTableReload(cameraTableIns, {garageId: parseInt(data.value)});
        });
    });


</script>
</body>

</html>
