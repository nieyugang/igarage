<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="robots" content="all,follow">
    <link rel="stylesheet" href="../../vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../vendor/layui/css/layui.css">
    <link rel="stylesheet" href="../../css/style.default.css" id="theme-stylesheet">
</head>

<body>
<form class="layui-form" action="">
    <div class="layui-form-item">
        <div class="layui-input-inline">
            <select name="firstLevel" id="firstLevel" lay-filter="firstLevel">
            </select>
        </div>
        <div class="layui-input-inline">
            <select name="secondLevel" id="secondLevel" lay-filter="secondLevel">
            </select>
        </div>
        <div class="layui-input-inline">
            <select name="areaLevel" id="areaLevel">
                <option value="1" selected="">丽华新村</option>
                <option value="2">清潭新村</option>
                <option value="3">邮电公寓</option>
            </select>
        </div>
        <div class="layui-input-inline">
            <select name="igarageId" id="igarageId" lay-filter="igarageId">
                <option value="1">丽华新村1号车库</option>
                <option value="2">丽华新村2号车库</option>
                <option value="3" selected>丽华新村3号车库</option>
            </select>
        </div>
    </div>

    <table id="table_door" lay-filter="table_door"></table>

    <script type="text/html" id="acTpl">
        <select lay-ignore>
            <option value="1">单门双向控制器</option>
            <option value="2">四门单向控制器</option>
        </select>
    </script>

    <div class="layui-form-item">
        <div class="layui-input-inline">
            <button type="button" class="layui-btn">设置网络</button>
        </div>
        <div class="layui-input-inline">
            <button type="button" class="layui-btn">清除权限</button>
        </div>
        <div class="layui-input-inline">
            <button type="button" class="layui-btn">设置时间</button>
        </div>
        <div class="layui-input-inline">
            <button type="button" class="layui-btn">设置门</button>
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-input-inline">
            <button type="button" class="layui-btn" lay-filter="icCard" id="icCard">IC卡用户管理</button>
        </div>
        <div class="layui-input-inline">
            <button type="button" class="layui-btn" lay-filter="access" id="access">门禁操作</button>
        </div>
    </div>
    <input id="accessId" value="aa" type="hidden"/>

</form>

<!-- js插件 -->
<script src="../../vendor/jquery/jquery.min.js"></script>
<script src="../../vendor/layui/layui.js"></script>
<script src="../../vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="../../js/front.js"></script>
<script src="../../js/common.js"></script>
<script>
    var baseUrl = "/hqigservice";
    layui.use(['table','form','element','layer'], function () {
        var table = layui.table
            ,element = layui.element
            ,layer = layui.layer
            ,form = layui.form;

        layer.ready(function(){
            var pdata = getPData();
            for(var i in pdata){
                $("#firstLevel").append('<option value="' + pdata[i].id + '">' + pdata[i].name + '</option>');
            }

            var pid = pdata[0].id;
            var cdata = getCData(pid);
            for(var j in cdata){
                $("#secondLevel").append('<option value="' + cdata[j].id + '">' + cdata[j].name + '</option>');
            }
            form.render('select');
        });

        initTable(table, "小区所属门禁信息表", "table_door", 10, '/getAccessControllerList.json',
            { "userInfo": userInfo,"garageId": parseInt($("#igarageId").val())},
            function (res) {
                return {
                    code: 0,
                    msg: "",
                    count: res.accessControllerInfoList ? res.accessControllerInfoList.length : 0,
                    data: res.accessControllerInfoList
                };
            },[[
                { type: 'radio', fixed: 'left'},
                { type: 'numbers', title: '序号', align: 'center' },
                {field:'acType', title:'控制器类型',templet: function(x){
                    return x.acType>1 ? '四门单向控制器': '单门双向控制器';
                }},
                {field:'sn', title:'产品序列号'},
                {field:'ip', title:'IP'},
                {field:'port', title:'PORT'},
                {field:'remark', title:'所在区域'},
                {field:'mac', title:'所控制的门'}
            ]], 'default')

        // 表格初始化
        // table.render({
        //     title: '小区所属门禁信息表',
        //     elem: '#table_door',
        //     height: 'full-200',
        //     method: 'POST',
        //     contentType: 'application/json',
        //     limit: 30,
        //     url: baseUrl + '/getAccessControllerList.json',
        //     where: {
        //         "userInfo": userInfo,
        //         "garageId": parseInt($("#igarageId").val())
        //     },
        //     parseData: function (res) {
        //         return {
        //             code: 0,
        //             msg: "",
        //             count: res.accessControllerInfoList ? res.accessControllerInfoList.length : 0,
        //             data: res.accessControllerInfoList
        //         };
        //     },
        //     toolbar: 'default',
        //     page: true,
        //     cols: [[
        //         { type: 'radio', fixed: 'left'},
        //         { type: 'numbers', title: '序号', align: 'center' },
        //         {field:'acType', title:'控制器类型',templet: function(x){
        //                 return x.acType>1 ? '四门单向控制器': '单门双向控制器';
        //             }},
        //         {field:'sn', title:'产品序列号'},
        //         {field:'ip', title:'IP'},
        //         {field:'port', title:'PORT'},
        //         {field:'remark', title:'所在区域'},
        //         {field:'mac', title:'所控制的门'}
        //     ]]
        // });

        // 监听头部工具栏事件
        table.on('toolbar(table_door)', function (obj) {
            var checkStatus = table.checkStatus(obj.config.id);
            var data = checkStatus.data; //获取选中的数据
            var layEvet = obj.event;
            switch (layEvet) {
                case 'add':
                    $("#accessId").attr("value","");
                    layer.open({
                        type: 2,
                        title: false,
                        anim: 1,
                        area: ['480px', '600px'],
                        content: './door-edit.html',
                        end: function () {
                            table.reload('table_door');
                        }
                    });
                    break;
                case 'update':
                    if (data.length === 0) {
                        layer.msg('请选择一行');
                    } else if (data.length > 1) {
                        layer.msg('只能同时编辑一个', function () { });
                    } else {
                        $("#accessId").attr("value",JSON.stringify(data[0]));
                        // layer.msg($("#accessId").val());
                        layer.open({
                            type: 2,
                            title: false,
                            anim: 1,
                            area: ['480px', '600px'],
                            content: './door-edit.html',
                            end: function () {
                                table.reload('table_door');
                            }
                        });

                    }
                    break;
                case 'delete':
                    if (data.length === 0) {
                        layer.msg('请选择一行');
                    } else {
                        layer.confirm('确定删除吗？', function (index) {
                            $.ajax({
                                url: baseUrl + '/accessControllerDelete.json',
                                type: 'POST',
                                data: JSON.stringify({
                                    "userInfo": userInfo,
                                    "acId": data[0].acId
                                }),
                                contentType: "application/json",
                                dataType: 'json',
                                async: true,
                                success: function (res) {
                                    if (res.resFlag == "N") {
                                        layer.msg('操作成功', { icon: 1 });
                                        setTimeout(function () {
                                            table.reload('table_door');
                                        }, 1000);
                                    } else {
                                        layer.msg(res.resFlag, { icon: 2 });
                                    }
                                },
                                error: function () {
                                    layer.msg(res.resFlag, { icon: 2 });
                                }
                            });
                        });
                    }
                    break;
            };
        });

        form.on('select(igarageId)', function(data){
            // layer.msg($("#igarageId").val());
            table.reload('table_door',{
                where: {
                    "userInfo": userInfo,
                    "garageId": parseInt($("#igarageId").val())
                }
            });
        });

        form.on('select(firstLevel)', function(data){
            var pid = data.value;
            var cdata = getCData(pid);
            $("#secondLevel").empty();
            for(var j in cdata){
                $("#secondLevel").append('<option value="' + cdata[j].id + '">' + cdata[j].name + '</option>');
            }
            form.render('select');
        })

        $(document).on('click','#access',function(){
            var elem = window.parent.layui.element;
            elem.tabDelete("_tab_iframe_", "door-operation.html");
            elem.tabAdd("_tab_iframe_", {
                title: "门禁操作",
                content: '<iframe scrolling="auto" frameborder="0" src="/html/igarage/door-operation.html" style="width: 100%;height: 100%;display: block;"></iframe>',
                id: "door-operation.html"
            });
            elem.tabChange("_tab_iframe_", "door-operation.html");
        });

        $(document).on('click','#icCard',function(){
            var elem = window.parent.layui.element;
            elem.tabDelete("_tab_iframe_", "iccard.html");
            elem.tabAdd("_tab_iframe_", {
                title: "IC卡管理",
                content: '<iframe scrolling="auto" frameborder="0" src="/html/igarage/iccard.html?igarageId='+$("#igarageId").val()+'" style="width: 100%;height: 100%;display: block;"></iframe>',
                id: "iccard.html"
            });
            elem.tabChange("_tab_iframe_", "iccard.html");

        });

        //获取省列表
        function getPData() {
            var pdata = [];
            $.ajax({
                url: baseUrl + '/getProvinceList.json',
                type: 'POST',
                data: JSON.stringify({
                    "userInfo": userInfo,
                }),
                contentType: "application/json",
                dataType: 'json',
                async: false,
                success: function (res) {
                    pdata =  res.provinceList;
                },
            });
            return pdata;
        }

        //获取市列表
        function getCData(pid) {
            var cdata = [];
            $.ajax({
                url: baseUrl + '/getCityList.json',
                type: 'POST',
                data: JSON.stringify({
                    "userInfo": userInfo,
                    "provinceId":parseInt(pid)
                }),
                contentType: "application/json",
                dataType: 'json',
                async: false,
                success: function (res) {
                    cdata = res.cityList;
                },
            });
            return cdata;
        }

        //获取市列表
        function getAreaData(cid) {
            $.ajax({
                url: baseUrl + '/getCityList.json',
                type: 'POST',
                data: JSON.stringify({
                    "userInfo": userInfo,
                    "provinceId":parseInt(pid)
                }),
                contentType: "application/json",
                dataType: 'json',
                async: true,
                success: function (res) {
                    return res.cityList;
                },
            });
        }
    });

</script>




</body>

</html>