<!DOCTYPE HTML>
<html>

<head>
	<title>EZUIKit控件 demo</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<script>
		if (typeof JSON !== "object") { JSON = {} } (function () { var rx_one = /^[\],:{}\s]*$/; var rx_two = /\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g; var rx_three = /"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g; var rx_four = /(?:^|:|,)(?:\s*\[)+/g; var rx_escapable = /[\\"\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g; var rx_dangerous = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g; function f(n) { return n < 10 ? "0" + n : n } function this_value() { return this.valueOf() } if (typeof Date.prototype.toJSON !== "function") { Date.prototype.toJSON = function () { return isFinite(this.valueOf()) ? this.getUTCFullYear() + "-" + f(this.getUTCMonth() + 1) + "-" + f(this.getUTCDate()) + "T" + f(this.getUTCHours()) + ":" + f(this.getUTCMinutes()) + ":" + f(this.getUTCSeconds()) + "Z" : null }; Boolean.prototype.toJSON = this_value; Number.prototype.toJSON = this_value; String.prototype.toJSON = this_value } var gap; var indent; var meta; var rep; function quote(string) { rx_escapable.lastIndex = 0; return rx_escapable.test(string) ? '"' + string.replace(rx_escapable, function (a) { var c = meta[a]; return typeof c === "string" ? c : "\\u" + ("0000" + a.charCodeAt(0).toString(16)).slice(-4) }) + '"' : '"' + string + '"' } function str(key, holder) { var i; var k; var v; var length; var mind = gap; var partial; var value = holder[key]; if (value && typeof value === "object" && typeof value.toJSON === "function") { value = value.toJSON(key) } if (typeof rep === "function") { value = rep.call(holder, key, value) } switch (typeof value) { case "string": return quote(value); case "number": return isFinite(value) ? String(value) : "null"; case "boolean": case "null": return String(value); case "object": if (!value) { return "null" } gap += indent; partial = []; if (Object.prototype.toString.apply(value) === "[object Array]") { length = value.length; for (i = 0; i < length; i += 1) { partial[i] = str(i, value) || "null" } v = partial.length === 0 ? "[]" : gap ? "[\n" + gap + partial.join(",\n" + gap) + "\n" + mind + "]" : "[" + partial.join(",") + "]"; gap = mind; return v } if (rep && typeof rep === "object") { length = rep.length; for (i = 0; i < length; i += 1) { if (typeof rep[i] === "string") { k = rep[i]; v = str(k, value); if (v) { partial.push(quote(k) + (gap ? ": " : ":") + v) } } } } else { for (k in value) { if (Object.prototype.hasOwnProperty.call(value, k)) { v = str(k, value); if (v) { partial.push(quote(k) + (gap ? ": " : ":") + v) } } } } v = partial.length === 0 ? "{}" : gap ? "{\n" + gap + partial.join(",\n" + gap) + "\n" + mind + "}" : "{" + partial.join(",") + "}"; gap = mind; return v } } if (typeof JSON.stringify !== "function") { meta = { "\b": "\\b", "\t": "\\t", "\n": "\\n", "\f": "\\f", "\r": "\\r", '"': '\\"', "\\": "\\\\" }; JSON.stringify = function (value, replacer, space) { var i; gap = ""; indent = ""; if (typeof space === "number") { for (i = 0; i < space; i += 1) { indent += " " } } else { if (typeof space === "string") { indent = space } } rep = replacer; if (replacer && typeof replacer !== "function" && (typeof replacer !== "object" || typeof replacer.length !== "number")) { throw new Error("JSON.stringify") } return str("", { "": value }) } } if (typeof JSON.parse !== "function") { JSON.parse = function (text, reviver) { var j; function walk(holder, key) { var k; var v; var value = holder[key]; if (value && typeof value === "object") { for (k in value) { if (Object.prototype.hasOwnProperty.call(value, k)) { v = walk(value, k); if (v !== undefined) { value[k] = v } else { delete value[k] } } } } return reviver.call(holder, key, value) } text = String(text); rx_dangerous.lastIndex = 0; if (rx_dangerous.test(text)) { text = text.replace(rx_dangerous, function (a) { return "\\u" + ("0000" + a.charCodeAt(0).toString(16)).slice(-4) }) } if (rx_one.test(text.replace(rx_two, "@").replace(rx_three, "]").replace(rx_four, ""))) { j = eval("(" + text + ")"); return (typeof reviver === "function") ? walk({ "": j }, "") : j } throw new SyntaxError("JSON.parse") } } }());
	</script>

	<style>
		object {
			margin-top: -3px;
			margin-left: 1px;
		}
	</style>
</head>

<body>

	<table>
		<tr>
			<td>
				<div id="camera-container" style="width: 885px;height:500px;">
				</div>
			</td>
		</tr>
	</table>
	<!-- js插件 -->
	<script src="../../vendor/jquery/jquery.min.js"></script>
	<script src="../../vendor/layui/layui.js"></script>
	<script src="../../js/front.js"></script>
	<script src="../../js/common.js"></script>
	<script type="text/javascript">

		layui.use('layer', function () {
			var layer = layui.layer;
		});
		//全局变量
		var gAppKey = "150c6adecae64a4b9dae7dd9717daae8";
		var gAppSecret = "f98ecf11918ac14c605fbfa71fa83bd2";
		var gAccessToken;			//accesstoken
		var size;

		//查询设备状态，在线才可预览/
		function checkDeviceInfo(gAppKey, gAccessToken, deviceSerial) {
			var url = "https://open.ys7.com/api/lapp/device/info?accessToken=" + gAccessToken + "&deviceSerial=" + deviceSerial;
			$.ajax({
				url: url,
				type: 'POST',
				contentType: 'application/x-www-form-urlencoded',
				dataType: 'json',
				async: false,
				success: function (res) {
					if ("200" == res.code) {
						//Play();
						getcameraList(gAppKey, gAccessToken, deviceSerial);
					} else {
						layer.msg(res.msg, { icon: 2 });
					}
				},
				error: function () {
					layer.msg("网络错误", { icon: 2 });
				}
			});
		}
		//获取设备的通道信息
		function getcameraList(gAppKey, gAccessToken, deviceSerial) {
			var url = "https://open.ys7.com/api/lapp/device/camera/list?accessToken=" + gAccessToken + "&deviceSerial=" + deviceSerial;
			$.ajax({
				url: url,
				type: 'POST',
				contentType: 'application/x-www-form-urlencoded',
				dataType: 'json',
				async: false,
				success: function (res) {
					if ("200" == res.code) {
						//添加所有通道播放窗口
						var containerDom = $("#camera-container");
						var channelListInfo = res.data;

						//定义分屏
						size = channelListInfo.length;
						var divWidth = 880;
						var divHeight = 500;
						var width;
						var height;
						if (1 >= size) { //1*1
							width = divWidth;
							height = divHeight;
						} else if (1 < size && size <= 4) { //2*2
							width = divWidth / 2;
							height = divHeight / 2;
						} else if (4 < size && size <= 9) { //3*3
							width = divWidth / 3;
							height = divHeight / 3;
						} else if (9 < size && size <= 16) { //4*4
							width = divWidth / 4;
							height = divHeight / 4;
						} else if (16 < size && size <= 25) { // 5*5
							width = divWidth / 5;
							height = divHeight / 5;
						} else { // 6*6
							width = divWidth / 6;
							height = divHeight / 6;
						}

						for (var i in channelListInfo) {
							if (channelListInfo.hasOwnProperty(i)) {
								var index = parseInt(i) + 1;
								containerDom.append($('<object classid="clsid:54FC7795-1014-4BF6-8BA3-500C61EC1A05" id="EZUIKit' + index + '" width="' + width + '" height="' + height + '" 	name="EZUIKit' + index + '"></object>'));
							}
						}
					} else {
						layer.msg(res.msg, { icon: 2 });
					}
				},
				error: function () {
					layer.msg("网络错误", { icon: 2 });
				}
			});
			playAll(size, gAppKey, gAccessToken, deviceSerial);
		}

		//全部预览
		function playAll(size, gAppKey, gAccessToken, deviceSerial) {
			for (var index = 1; index <= size; index++) {
				var EZUIKitID = "EZUIKit" + index;
				var ezurl = "ezopen://open.ys7.com/" + deviceSerial + "/" + index + ".hd.live";
				Play(EZUIKitID, gAppKey, gAccessToken, ezurl);

			}
		}
		//预览函数
		function Play(EZUIKitID, gAppKey, gAccessToken, ezurl) {
			// var index = layer.load(1, { time: 8 * 1000 });//由于视频流加载有一定时间，此处添加loading，并跟进加载时长设定6s后自动关闭。
			//得到控件引用
			var playOcx = document.getElementById(EZUIKitID);
			if (!playOcx) {
				layer.msg("EZUIKit异常，无法正常播放", { icon: 2 });
				return;
			}
			var appkey = gAppKey;
			var accesstoken = gAccessToken;// "at.47g932qxaj85hc8p0r2lhjckc271rt3u-8z4i5jphjn-0gcqr39-wobgwqamr";
			var ezurl = ezurl;
			//检测取流参数
			if (appkey == "" || accesstoken == "" || ezurl == "") {
				layer.msg("通道不存在，设备参数错误，无法正常播放", { icon: 2 });
				return;
			}
			//设置appkey
			var res = playOcx.InitWithAppKey(appkey);
			if (0 != res) {
				layer.msg("appkey和AccessToken不匹配,建议更换appkey或者AccessToken，无法正常播放", { icon: 2 });
				return;
			}
			//设置accesstoken
			var res = playOcx.SetAccessToken(accesstoken);
			if (0 != res) {
				layer.msg("appkey和AccessToken不匹配,建议更换appkey或者AccessToken，无法正常播放", { icon: 2 });
				return;
			}
			//开始播放, 播放结果 根据 PluginEventHandler 回调函数
			var res = playOcx.StartPlay(ezurl);
			if (0 != res) {
				layer.msg("播放异常！请检查参数", { icon: 2 });
				return;
			}
		}
		//检查activeX插件是否已安装并加载
		function TestActiveX() {
			try {
				var ax = new ActiveXObject("EZOPENUIACTIVEXK.EzOpenUIActiveXKCtrl.1");
				bInstall = true;
			} catch (e) {
				alert("未安装");
			}
		}
		//从redis服务器获取token
		function getAccessTokenFromRedis() {
			sendAjaxRequest("POST", "/hikGetToken.json", "JSON", {}, successCallback);
			function successCallback(res) {
				if ("N" == res.resFlag) {
					if (res.token == null) {
						//redis中不存在则从海康接口动态获取token并存入redis中
						getAccessTokenFromHikVision();
					} else {
						gAccessToken = res.token
					}
					checkDeviceInfo(gAppKey, gAccessToken, "691363191");
				}
			}
		}

		//预览窗口最大化
		function maxPreWin(winIndex) {
			alert(winIndex);

		}
		//从hikvision服务器获取token
		function getAccessTokenFromHikVision() {
			var getAccessTokenUrl = "https://open.ys7.com/api/lapp/token/get?appKey=" + gAppKey + "&appSecret=" + gAppSecret;
			$.ajax({
				url: getAccessTokenUrl,
				type: 'POST',
				contentType: 'application/x-www-form-urlencoded',
				dataType: 'json',
				success: function (res) {
					if ("200" == res.code) {
						gAccessToken = res.data.accessToken;
						sendAjaxRequest("POST", "/hikSetToken.json", "JSON", JSON.stringify({ "token": res.data.accessToken }));//此处成功和异常的不处理整体对功能没有影响。
					} else {
						alert("获取token异常！");
					}
				},
				error: function () {
					alert("网络通信异常");
				}

			});
		}
		window.onload = function () {
			TestActiveX();
			// Play("EZUIKit1","150c6adecae64a4b9dae7dd9717daae8","at.47g932qxaj85hc8p0r2lhjckc271rt3u-8z4i5jphjn-0gcqr39-wobgwqamr","ezopen://open.ys7.com/122602365/5.live");
			getAccessTokenFromRedis();
		}
		window.unload = function () {
			alert("unload");
		}

	</script>
</body>

</html>